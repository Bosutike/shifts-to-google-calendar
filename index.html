<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift to Calendar Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .day-cell { min-height: 100px; transition: all 0.2s; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; }
        .day-cell:hover { background-color: #f8fafc; }
        .shift-badge { font-size: 0.7rem; padding: 2px 4px; border-radius: 4px; margin-top: 4px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-12">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <h1 class="text-xl font-bold text-slate-800">ShiftSync</h1>
            </div>

            <div class="flex items-center gap-3">
                <button id="authBtn" onclick="handleAuthClick()" class="flex items-center gap-2 px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 font-medium transition-all text-sm">
                    <img src="https://www.gstatic.com/images/branding/product/1x/g_suite_2020q4_48dp.png" class="w-4 h-4" alt="G">
                    <span>Connect Google</span>
                </button>
                <button id="signOutBtn" onclick="handleSignoutClick()" class="hidden px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg">Sign Out</button>
                <button onclick="syncToCalendar()" id="syncBtn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700 font-semibold shadow-sm transition-all text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                    Sync Current Month
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto mt-8 px-4 grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <!-- Sidebar: Shift Definitions -->
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">Your Shift Types</h2>
                <div id="shiftTypeList" class="space-y-3 mb-6">
                    <!-- Shift Items injected here -->
                </div>
                <button onclick="addNewShiftType()" class="w-full py-2 border-2 border-dashed border-slate-200 rounded-lg text-slate-400 hover:text-indigo-600 hover:border-indigo-300 transition-all text-sm font-medium">
                    + Add New Shift Type
                </button>
            </div>

            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                <h3 class="text-xs font-bold text-indigo-800 uppercase mb-2">Instructions</h3>
                <p class="text-xs text-indigo-700 leading-relaxed">
                    1. Define your shifts.<br>
                    2. Click a date to assign a shift.<br>
                    3. Navigate to the month you want to sync.<br>
                    4. Click "Sync Current Month" to update your Google Calendar.
                </p>
                <div class="mt-4 pt-4 border-t border-indigo-200">
                    <h3 class="text-xs font-bold text-indigo-800 uppercase mb-1">Security Note</h3>
                    <p class="text-[10px] text-indigo-700 leading-tight italic">
                        If hosting on GitHub, ensure you've added your URL to "Authorized JavaScript Origins" in Google Console to prevent unauthorized use of your Client ID.
                    </p>
                </div>
            </div>
        </div>

        <!-- Main Content: Calendar -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h2 id="currentMonthDisplay" class="text-lg font-bold text-slate-800">January 2024</h2>
                    <div class="flex gap-2">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-100 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-100 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>

                <div class="calendar-grid bg-slate-50 border-b border-slate-100">
                    <div class="text-center py-2 text-xs font-bold text-slate-400 uppercase">Sun</div>
                    <div class="text-center py-2 text-xs font-bold text-slate-400 uppercase">Mon</div>
                    <div class="text-center py-2 text-xs font-bold text-slate-400 uppercase">Tue</div>
                    <div class="text-center py-2 text-xs font-bold text-slate-400 uppercase">Wed</div>
                    <div class="text-center py-2 text-xs font-bold text-slate-400 uppercase">Thu</div>
                    <div class="text-center py-2 text-xs font-bold text-slate-400 uppercase">Fri</div>
                    <div class="text-center py-2 text-xs font-bold text-slate-400 uppercase">Sat</div>
                </div>

                <div id="calendarGrid" class="calendar-grid">
                    <!-- JS Injected Cells -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for Assigning Shifts -->
    <div id="assignModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] px-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">
            <h3 class="text-lg font-bold mb-4" id="modalTitle">Select Shift</h3>
            <div id="modalShiftOptions" class="space-y-2"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-6 right-6 translate-y-20 opacity-0 transition-all duration-300 bg-slate-900 text-white px-6 py-3 rounded-xl shadow-xl flex items-center gap-3 z-[1000]">
        <span id="toastMessage">Syncing...</span>
    </div>

    <script>
        const CLIENT_ID = '276844562286-biq705124253b75ro3fgj2o0garfci2v.apps.googleusercontent.com'; 
        const API_KEY = 'AIzaSyCnDviyu5RBWmZfaY7c7bIvtkcTwet_X04';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let selectedDate = null;

        let shiftTypes = JSON.parse(localStorage.getItem('shiftTypes')) || [
            { id: 1, name: 'Morning', start: '08:00', end: '16:00', color: '#6366f1' },
            { id: 2, name: 'Evening', start: '16:00', end: '00:00', color: '#f59e0b' }
        ];
        
        let schedule = JSON.parse(localStorage.getItem('schedule')) || {};

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const display = document.getElementById('currentMonthDisplay');
            grid.innerHTML = '';
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            display.innerText = `${monthNames[currentMonth]} ${currentYear}`;

            for (let i = 0; i < firstDay; i++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell bg-slate-50/50';
                grid.appendChild(cell);
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const cell = document.createElement('div');
                cell.className = 'day-cell p-2 cursor-pointer';
                cell.onclick = () => openAssignModal(dateKey, d);
                
                const dayNum = document.createElement('span');
                dayNum.className = 'text-sm font-medium text-slate-500';
                dayNum.innerText = d;
                
                cell.appendChild(dayNum);

                if (schedule[dateKey]) {
                    const shift = shiftTypes.find(s => s.id == schedule[dateKey]);
                    if (shift) {
                        const badge = document.createElement('div');
                        badge.className = 'shift-badge text-white';
                        badge.style.backgroundColor = shift.color;
                        badge.innerText = `${shift.name} (${shift.start})`;
                        cell.appendChild(badge);
                    }
                }
                grid.appendChild(cell);
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
        }

        function renderShiftTypes() {
            const list = document.getElementById('shiftTypeList');
            list.innerHTML = '';
            shiftTypes.forEach(shift => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-slate-50 rounded-lg border border-slate-100 space-y-2';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <input type="text" value="${shift.name}" onchange="updateShift(${shift.id}, 'name', this.value)" class="bg-transparent font-bold text-sm w-24 outline-none focus:text-indigo-600">
                        <button onclick="removeShiftType(${shift.id})" class="text-slate-400 hover:text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-slate-500">
                        <input type="time" value="${shift.start}" onchange="updateShift(${shift.id}, 'start', this.value)" class="bg-white border rounded px-1">
                        <span>to</span>
                        <input type="time" value="${shift.end}" onchange="updateShift(${shift.id}, 'end', this.value)" class="bg-white border rounded px-1">
                    </div>
                `;
                list.appendChild(div);
            });
            localStorage.setItem('shiftTypes', JSON.stringify(shiftTypes));
        }

        function addNewShiftType() {
            const id = Date.now();
            shiftTypes.push({ id, name: 'New Shift', start: '09:00', end: '17:00', color: '#6366f1' });
            renderShiftTypes();
        }

        function updateShift(id, field, value) {
            const shift = shiftTypes.find(s => s.id === id);
            if (shift) shift[field] = value;
            renderShiftTypes();
            renderCalendar();
        }

        function removeShiftType(id) {
            shiftTypes = shiftTypes.filter(s => s.id !== id);
            Object.keys(schedule).forEach(k => { if(schedule[k] == id) delete schedule[k]; });
            renderShiftTypes();
            renderCalendar();
        }

        function openAssignModal(dateKey, dayNum) {
            selectedDate = dateKey;
            document.getElementById('modalTitle').innerText = `Assign Shift: ${dayNum} ${document.getElementById('currentMonthDisplay').innerText}`;
            const container = document.getElementById('modalShiftOptions');
            container.innerHTML = `<button onclick="assignShift(null)" class="w-full text-left p-3 rounded-xl border border-slate-200 hover:bg-slate-50 text-sm font-medium transition-all">No Shift (Clear)</button>`;
            
            shiftTypes.forEach(shift => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-3 rounded-xl border border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 text-sm font-medium transition-all flex justify-between items-center';
                btn.onclick = () => assignShift(shift.id);
                btn.innerHTML = `<span>${shift.name} <span class="text-slate-400 font-normal ml-2">${shift.start} - ${shift.end}</span></span><div class="w-3 h-3 rounded-full" style="background-color: ${shift.color}"></div>`;
                container.appendChild(btn);
            });
            document.getElementById('assignModal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('assignModal').classList.add('hidden'); }

        function assignShift(shiftId) {
            if (shiftId === null) delete schedule[selectedDate];
            else schedule[selectedDate] = shiftId;
            localStorage.setItem('schedule', JSON.stringify(schedule));
            renderCalendar();
            closeModal();
        }

        function gapiLoaded() { gapi.load('client', initializeGapiClient); }

        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
            checkBeforeStart();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', 
            });
            gisInited = true;
            checkBeforeStart();
        }

        function checkBeforeStart() {
            if (gapiInited && gisInited) document.getElementById('syncBtn').disabled = false;
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                document.getElementById('authBtn').classList.add('hidden');
                document.getElementById('signOutBtn').classList.remove('hidden');
                showToast("Connected to Google!");
            };
            if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
            else tokenClient.requestAccessToken({prompt: ''});
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('authBtn').classList.remove('hidden');
                document.getElementById('signOutBtn').classList.add('hidden');
                showToast("Signed out.");
            }
        }

        async function syncToCalendar() {
            if (!gapi.client.getToken()) {
                handleAuthClick();
                return;
            }

            // Filter schedule for the CURRENTLY VISIBLE month and year only
            const visibleMonthPrefix = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const monthSchedule = Object.keys(schedule).filter(date => date.startsWith(visibleMonthPrefix));

            if (monthSchedule.length === 0) {
                showToast("No shifts assigned for this month.");
                return;
            }

            showToast(`Checking for duplicates...`);

            try {
                for (const dateStr of monthSchedule) {
                    const shiftId = schedule[dateStr];
                    const shift = shiftTypes.find(s => s.id == shiftId);
                    if (!shift) continue;

                    let startDate = new Date(dateStr + 'T' + shift.start);
                    let endDate = new Date(dateStr + 'T' + shift.end);
                    if (endDate <= startDate) endDate.setDate(endDate.getDate() + 1);

                    // SEARCH for existing event on this day to avoid duplicates
                    const timeMin = new Date(dateStr + 'T00:00:00Z').toISOString();
                    const timeMax = new Date(dateStr + 'T23:59:59Z').toISOString();
                    
                    const response = await gapi.client.calendar.events.list({
                        'calendarId': 'primary',
                        'timeMin': timeMin,
                        'timeMax': timeMax,
                        'q': `Shift: ${shift.name}`
                    });

                    const existing = response.result.items;
                    if (existing && existing.length > 0) {
                        console.log(`Skipping duplicate for ${dateStr}`);
                        continue;
                    }

                    const event = {
                        'summary': `Shift: ${shift.name}`,
                        'description': 'Created via ShiftSync App',
                        'start': { 'dateTime': startDate.toISOString(), 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone },
                        'end': { 'dateTime': endDate.toISOString(), 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone },
                    };

                    await gapi.client.calendar.events.insert({
                        'calendarId': 'primary',
                        'resource': event,
                    });
                }
                showToast("Month synced successfully!");
            } catch (err) {
                console.error(err);
                showToast("Error syncing. Check console.");
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        window.onload = () => {
            renderShiftTypes();
            renderCalendar();
            gapiLoaded();
            gisLoaded();
        };
    </script>
</body>
</html>
